Subject: [External] : Re: [vs] CVE-2021-4034 (patch)
Date: Tue, 11 Jan 2022 21:48:02 +0000
From: Qualys Security Advisory <qsa@qualys.com>
To: distros@vs.openwall.org <distros@vs.openwall.org>

diff --git a/src/programs/pkcheck.c b/src/programs/pkcheck.c
index f1bb4e1..aff4f60 100644
--- a/src/programs/pkcheck.c
+++ b/src/programs/pkcheck.c
@@ -363,6 +363,12 @@ main (int argc, char *argv[])
   local_agent_handle = NULL;
   ret = 126;

+  if (argc < 1)
+  {
+    help();
+    exit(1);
+  }
+
   /* Disable remote file access from GIO. */
   setenv ("GIO_USE_VFS", "local", 1);
 
diff --git a/src/programs/pkexec.c b/src/programs/pkexec.c
index 7698c5c..d84dc57 100644
--- a/src/programs/pkexec.c
+++ b/src/programs/pkexec.c
@@ -495,6 +495,16 @@ main (int argc, char *argv[])
   pid_t pid_of_caller;
   gpointer local_agent_handle;

+  /*
+  * If 'pkexec' is called wrong, just show help and bail out.
+  */
+  if (argc<1)
+  {
+    clearenv();
+    usage(argc, argv);
+    exit(1);
+  }
+
   ret = 127;
   authority = NULL;
   subject = NULL;
@@ -643,7 +654,15 @@ main (int argc, char *argv[])
           goto out;
         }
       g_free (path);
-      argv[n] = path = s;
+      path = s;
+
+      /* argc<2 and pkexec runs just shell, argv is guaranteed to be null-terminated.
+      * /-less shell shouldn't happen, but let's be defensive and don't write to null-termination
+      */
+      if (argv[n] != NULL)
+      {
+        argv[n] = path;
+      }
     }
   if (access (path, F_OK) != 0)
     {
